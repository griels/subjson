CMAKE_MINIMUM_REQUIRED(VERSION 2.8.9)
PROJECT(subjson)
SET(SUBJSON_GTEST ${PROJECT_SOURCE_DIR}/contrib/gtest)
INCLUDE_DIRECTORIES(${PROJECT_SOURCE_DIR})
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
set(CMAKE_CXX_EXTENSIONS OFF)
INCLUDE(CTest)

if (COUCHBASE_SERVER_BUILD)
   INCLUDE_DIRECTORIES(AFTER ${Platform_SOURCE_DIR}/include)
   ADD_DEFINITIONS(-DCOUCHBASE_BUILD)
   ENABLE_CODE_COVERAGE_REPORT()
   SET(EXTRA_LIBS platform)
else(COUCHBASE_SERVER_BUILD)
   SET(EXTRA_LIBS "")
endif(COUCHBASE_SERVER_BUILD)

if((CMAKE_COMPILER_IS_GNUCXX OR CMAKE_CXX_COMPILER_ID STREQUAL "Clang")
    AND NOT COUCHBASE_SERVER_BUILD)
    SET(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -std=c++11 -Wall -Wextra -pedantic")
endif()

SET(CMAKE_RUNTIME_OUTPUT_DIRECTORY ${PROJECT_BINARY_DIR}/bin)
SET(CMAKE_ARCHIVE_OUTPUT_DIRECTORY ${PROJECT_BINARY_DIR}/lib)
IF(WIN32)
    SET(CMAKE_LIBRARY_OUTPUT_DIRECTORY ${PROJECT_BINARY_DIR}/bin)
    ADD_DEFINITIONS(-D_CRT_SECURE_NO_WARNINGS)
ELSE()
    SET(CMAKE_LIBRARY_OUTPUT_DIRECTORY ${PROJECT_BINARY_DIR}/lib)
ENDIF()

SET(SUBJSON_SRC subdoc/match.cc subdoc/operations.cc subdoc/path.cc
    subdoc/util.cc src/cpp/slowmatcher.cpp)
ADD_LIBRARY(subjson ${SUBJSON_SRC})
TARGET_LINK_LIBRARIES(subjson ${EXTRA_LIBS})
ADD_EXECUTABLE(bench bench.cc contrib/cliopts/cliopts.c)
TARGET_LINK_LIBRARIES(bench subjson)

set_target_properties(subjson PROPERTIES
        CXX_STANDARD 17
        CXX_EXTENSIONS OFF
        )

set_property(TARGET subjson PROPERTY CXX_STANDARD 17)

IF(EXISTS ${SUBJSON_GTEST} OR EXISTS ${gtest_SOURCE_DIR})
  ENABLE_TESTING()
  ADD_SUBDIRECTORY(tests)
ENDIF(EXISTS ${SUBJSON_GTEST} OR EXISTS ${gtest_SOURCE_DIR})
